#!/usr/bin/env bash

# ------------------------------------------------------------------------------
# gmx_ISA - GROMACS Instant Simulation Analysis
# Copyright (c) 2026 Antônio P. L. de Mesquita
# Licensed under the MIT License 
#
# MIT License
#
# Copyright (c) 2026 Antônio P. L. de Mesquita
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
# 
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
# ------------------------------------------------------------------------------

# ==============================================================================
# 1. CONFIGURAÇÃO DE AMBIENTE E RESOLUÇÃO DE CAMINHOS
# =============================================================================

# Descobre onde este script (gmx_ISA) está instalado/localizado
# Este bloco resolve links simbólicos (vital para Conda/Linux)
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do 
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" 
done
BIN_DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

# Define a Raiz do Projeto (sobe um nível a partir de /bin)
PROJECT_ROOT="$(dirname "$BIN_DIR")"

# Define os caminhos absolutos baseados na estrutura de pastas
LIB_DIR="$PROJECT_ROOT/lib/gmx_ISA"
PYTHON_DIR="$LIB_DIR/scripts"
GEN_CONF_SCRIPT="$LIB_DIR/gen_conf.sh"
TEMPLATE_FILE="$LIB_DIR/templates/variables.conf"

# --- VERIFICAÇÕES DE SEGURANÇA ---
# Garante que a estrutura de pastas está íntegra antes de rodar
if [ ! -d "$PYTHON_DIR" ]; then
    echo "CRITICAL ERROR: Python scripts directory not found at:"
    echo "  $PYTHON_DIR"
    echo "Please check your installation or directory structure."
    exit 1
fi

if [ ! -f "$GEN_CONF_SCRIPT" ]; then
    echo "WARNING: Helper script 'gen_conf.sh' not found in library ($LIB_DIR)."
fi

# ==============================================================================
# 2. FUNÇÕES AUXILIARES E VISUAIS
# ==============================================================================

center_echo() {
    local text="$1"
    local term_width=$(tput cols)
    local text_length=${#text}
    local padding=$(( (term_width - text_length) / 2 ))
    printf "%*s%s\n" $padding "" "$text"
}

show_help() {
      cat << "EOF"

                :-) gmx_ISA - GROMACS Instant Simulation Analysis vt. 6.16.11 (-:

Hey! I can help you learn how to use gmx_ISA. Let’s go!

Command line:
  gmx_ISA -h

SYNOPSIS

gmx_ISA [-s [<.tpr>]] [-f [<.xtc>]] [-n [<.ndx>]] [-en [<.edr>]]
        [-center] [-rms_lig] [-rms_lig2] [-rms_prot] [-rmsf_prot] [-rmsf_lig]
        [-hbond] [-etot] [-ecoul] [-elj] [-gyr] [-sasa] [-fel]
        [-sys <prot,lig>] [-e <time (ps)>] [-b <time (ps)>] [-rdf] [-solo]
        [-int [<Coul.xvg>] [<LJ.xvg>]] [-fel3d [<PC1_PC2.xvg>] <temp> <nbins> <smooth>]
        [-reg [<Coul.xvg>] [<LJ.xvg>]] [-isa [<Coul.xvg>] [<LJ.xvg>]] 
        [-autocor [<Coul.xvg>] [<LJ.xvg>]] [-diff [<msd.xvg>]]
        [-conv_pbsa [<.csv>]] [-extract_qm <lig_resname> <cutoff_angst> <stride>]
        [-run_xtb --ligand_charge <int>]

DESCRIPTION

gmx_ISA (GROMACS Instant Simulation Analysis) is an automated free tool designed to simplify and
accelerate the analysis of molecular dynamics trajectories generated with GROMACS. It also 
features QM/MM workflows, advanced statistical analysis, and publication-quality plotting.

OPTIONS

Options to specify input files:

    -s                Input <.tpr> file (overrides variables.conf);
    -f                Input <.xtc> file (overrides variables.conf);
    -n                Input <.ndx> file (overrides variables.conf);
    -en               Input <.edr> file (overrides variables.conf).

Default analyses. When no flags are provided, the following analyses are performed by default:

    -center           Centralize your <.xvg> trajectory and remove PBC;
    -rms_lig          Calculates de RMSD of your ligand;
    -rms_lig2         Calculates the RMSD of a second ligand (e.g., a cofactor or coenzyme);
    -rms_prot         Calculates the RMSD of the Protein (backbone);
    -rmsf_prot        Calculates the RMSD of the Protein;
    -rmsf_lig         Calculates the RMSD of the ligand;
    -hbond            Calculates the number of hydrogen bonds between protein and ligand;
    -etot             Calculates the total energy of the system;
    -ecoul            Calculates the Coulomb Short-Range energy;
    -elj              Calculates the Lennard-Jones Short-Range energy.

Additional analyses performed using GROMACS

    -gyr              Calculates the protein's Radius of Gyration;
    -sasa             Calculates the protein's Solvent Accessible Surface Area;
    -fel              Calculates Free Energy Landscapes through PC1 and PC2, you need to 
                      define a system (-sys) and a time intervall (-b, -e);
    -sys              System to perform FEL <ligand, protein>;
    -b                Initial time of the trajectory in picosseconds;
    -e                Final time of the trajectory in picosseconds;
    -rdf              Calculates RDF between ligand and water (OW);
    -solo             Use this flag if you wouldn't like to use gen_conf.
    
External analyses implemented with Python modules. Please run one flag at a time.

    -int              Calculates MM interaction energy (Coulomb-SR + LJ-SR) and statistics.
                      Usage: gmx_ISA -int <Coulomb_energy>.xvg <LJ_energy>.xvg;
    -fel3d            Plots the 3D and 2D free energy landscape from PC1 and PC2 data.
    		      Usage: gmx_ISA -fel3d <pc1_pc2.xvg> <Temperature_K> <nbins> <sigma_smooth>;
    -reg	      Performs linear regression between Coulomb-SR and LJ-SR energies.
                      Usage: gmx_ISA -reg <Coulomb_energy>.xvg <LJ_energy>.xvg;
    -isa              Calculates the ISA index (Interaction Stability Analysis): the ratio of the mean interaction
                      energy to the standard deviation.
                      Usage: gmx_ISA -isa <Coulomb_energy>.xvg <LJ_energy>.xvg;
    -autocor          Calculates the autocorrelation of the interaction energy and the autocorrelation time by integration.
                      Usage: gmx_ISA -autocor <Coulomb_energy>.xvg <LJ_energy>.xvg;
    -diff             Automatically detects the region with the highest linear incidence from MSD results and
                      calculates the diffusion coefficient using the Einstein equation.
                      Usage: gmx_ISA -diff <msd_file>.xvg;
    -conv_pbsa        Calculates the Cumulative Moving Average for free energy convergence analysis.
                      Fully optimized for energy outputs from gmx_MMPBSA.
                      Usage: gmx_ISA -conv_pbsa <FINAL_RESULTS_MMPBSA.csv>
    
Options for QM calculations using xTB 

    -extract_qm       Extracts the region from the <.xtc> file to be treated quantum mechanically and performs automatic
                      capping of broken peptide bonds.
                      Usage: gmx_ISA -extract_qm <ligand_resname> <cutoff_angstroms> <stride>
    -xtb_run          Performs a semi-empirical quantum calculation with GFN2-xTB using the configured QM region.
                      Requires the --ligand_charge flag to specify the total ligand charge.
                      Usage: gmx_ISA -xtb_run --ligand_charge <int>
    --ligand_charge   Flag to specify the ligand charge; it must be a positive or negative integer.
    
EOF
}

progress_bar_real_time() {
  command="$1"
  
  start_time=$(date +%s)
  # Executa o comando em background com log para debug
  eval "$command >> gmx_ISA_debug.log 2>&1" &
  pid=$!
  
  term_width=$(tput cols)
  bar_width=$((term_width - 20))

  while kill -0 "$pid" 2>/dev/null; do
    current_time=$(date +%s)
    elapsed=$((current_time - start_time))
    filled_length=$(( (elapsed * 2) % bar_width ))
    if [ $filled_length -eq 0 ]; then filled_length=1; fi
    bar=$(printf "#%.0s" $(seq 1 "$filled_length"))
    spaces=$(printf " %.0s" $(seq 1 $((bar_width - filled_length))))
    printf "\\r[%-${bar_width}s] Running... (%ds)" "$bar$spaces" "$elapsed"
    sleep 0.5
  done

  wait "$pid"
  end_time=$(date +%s)
  total_time=$((end_time - start_time))
  printf "\\r[%-${bar_width}s] 100%% (%ds)\\n" "$(printf "#%.0s" $(seq 1 "$bar_width"))" "$total_time"
}

# ==============================================================================
# 3. VERIFICAÇÃO INICIAL (HELP / SOLO)
# ==============================================================================

clear
solo_mode=false

# Verifica se existe -solo ou -h na linha de comando inteira antes de começar
for arg in "$@"; do
  if [[ "$arg" == "-h" ]]; then
      show_help
      exit 0
  fi
  if [[ "$arg" == "-solo" ]]; then
    solo_mode=true
  fi
done

# ==============================================================================
# 4. INTERFACE DE BOAS VINDAS
# ==============================================================================

if [ "$solo_mode" = false ]; then
    for i in {1..4}; do echo ""; done

    center_echo '                          ___ ____    _    '
    center_echo '  __ _ _ __ ___ __  __   |_ _/ ___|  / \   '
    center_echo ' / _` | '\''_ ` _ \\ \/ /    | |\___ \ / _ \  '
    center_echo '| (_| | | | | | |>  <     | | ___) / ___ \ '
    center_echo '            \__, |_| |_| |_/_/\_\___|___|____/_/   \_\  vt. 6.16.11'
    center_echo '|___/              |____|                '
    center_echo ""
    center_echo ":-) A FREE TOOL FOR GROMACS - gmx_ISA (Instant Simulation Analysis) (-:"
    center_echo "GMX_ISA is written by:"
    center_echo "Antônio P. L. de Mesquita"
    for i in {1..4}; do echo ""; done

    echo "Hello! I'm gmx_ISA and I'm glad to help you analyze your molecular dynamics trajectories in few steps, easy and quick! Let's start? (-:"
    
    echo "Would you like to use gen_conf interactive bash interface? (yes/no)"
    read resposta

    if [[ "$resposta" == "yes" ]]; then
      temp_ndx=$(find . -maxdepth 1 -type f -name "*.ndx" | head -n 1)
      temp_edr=$(find . -maxdepth 1 -type f -name "*.edr" | head -n 1)
      
      if [[ -f "$temp_ndx" ]]; then gmx check -n "$temp_ndx" 2>/dev/null; fi
      
      if [[ -f "$temp_edr" ]]; then 
          echo "200 200" | gmx energy -f "$temp_edr" 2>&1 | grep -A 100 "line or a zero" > engopt.dat
          tail -n +2 engopt.dat | head -n 15
      fi
      
      # CORREÇÃO: Usa o caminho da biblioteca para o gen_conf
      if [[ -f "$GEN_CONF_SCRIPT" ]]; then
          source "$GEN_CONF_SCRIPT"
          echo "gen_conf interface was successfully finished."
      else
          echo "Error: gen_conf.sh not found inside library path: $GEN_CONF_SCRIPT"
      fi
    fi
fi

# ==============================================================================
# 5. CARREGAMENTO E PARSING DE VARIÁVEIS
# ==============================================================================

# 1. Carrega defaults do arquivo
if [[ ! -f "variables.conf" ]]; then
    if [ "$solo_mode" = false ]; then
        # CORREÇÃO: Tenta copiar do template se não existir localmente
        if [[ -f "$TEMPLATE_FILE" ]]; then
             echo "Copying default 'variables.conf' from template..."
             cp "$TEMPLATE_FILE" .
        else
             echo "Warning: 'variables.conf' not found locally and template missing."
        fi
    fi
fi

# Carrega se existir (agora ou antes)
if [[ -f "variables.conf" ]]; then
    source variables.conf
fi 

# 2. Inicializa variáveis de controle
DO_CENTER=false
DO_RMS_LIG=false
DO_RMS_LIG2=false
DO_RMS_PROT=false
DO_RMSF_PROT=false
DO_RMSF_LIG=false
DO_HBOND=false
DO_ETOT=false
DO_ECOUL=false
DO_ELJ=false
DO_GYR=false
DO_SASA=false
DO_FEL=false
DO_INT=false
DO_RDF=false
DO_FEL3D=false
DO_REG=false
DO_ISA=false
DO_AUTOCOR=false
DO_DIFF=false
DO_CONV_PBSA=false
DO_EXTRACT_QM=false
DO_XTB_RUN=false
xtb_charge="0"
CUSTOM_FLAG_USED=false

# Variáveis para argumentos compostos
fel_sys=""
fel_b=""
fel_e=""
int_file_coulomb=""
int_file_lj=""
fel3d_file=""
fel3d_temp=""
fel3d_bins=""
fel3d_sigma=""

# 3. LOOP DE PARSING SEGURO
while [[ $# -gt 0 ]]; do
    case "$1" in
        # FLAGS DE INPUT
        -s)  tpr="$2"; shift 2 ;;
        -f)  xtc="$2"; shift 2 ;;
        -n)  ndx="$2"; shift 2 ;;
        -en) edr="$2"; shift 2 ;;
        
        # FLAGS DE AÇÃO
        -center)     DO_CENTER=true;      CUSTOM_FLAG_USED=true; shift ;;
        -rms_lig)    DO_RMS_LIG=true;     CUSTOM_FLAG_USED=true; shift ;;
        -rms_lig2)   DO_RMS_LIG2=true;    CUSTOM_FLAG_USED=true; shift ;;
        -rms_prot)   DO_RMS_PROT=true;    CUSTOM_FLAG_USED=true; shift ;;
        -rmsf_prot)  DO_RMSF_PROT=true;   CUSTOM_FLAG_USED=true; shift ;;
        -rmsf_lig)   DO_RMSF_LIG=true;    CUSTOM_FLAG_USED=true; shift ;;
        -hbond)      DO_HBOND=true;       CUSTOM_FLAG_USED=true; shift ;;
        -etot)       DO_ETOT=true;        CUSTOM_FLAG_USED=true; shift ;;
        -ecoul)      DO_ECOUL=true;       CUSTOM_FLAG_USED=true; shift ;;
        -elj)        DO_ELJ=true;         CUSTOM_FLAG_USED=true; shift ;;
        -gyr)        DO_GYR=true;         CUSTOM_FLAG_USED=true; shift ;;
        -sasa)       DO_SASA=true;        CUSTOM_FLAG_USED=true; shift ;;
        -rdf)        DO_RDF=true;         CUSTOM_FLAG_USED=true; shift ;;
        
        # FLAGS COMPLEXAS
        -fel) DO_FEL=true; CUSTOM_FLAG_USED=true; shift ;;
        -sys) fel_sys="$2"; shift 2 ;;
        -b)   fel_b="$2";   shift 2 ;;
        -e)   fel_e="$2";   shift 2 ;;
        
        -int) 
             DO_INT=true; CUSTOM_FLAG_USED=true
             int_file_coulomb="$2"
             int_file_lj="$3"
             shift 3 
             ;;
             
        -reg) 
             DO_REG=true; CUSTOM_FLAG_USED=true
             reg_file_coulomb="$2"
             reg_file_lj="$3"
             shift 3 
             ;;
         
        -isa) 
             DO_ISA=true; CUSTOM_FLAG_USED=true
             isa_file_coulomb="$2"
             isa_file_lj="$3"
             shift 3 
             ;;
             
        -autocor)
             DO_AUTOCOR=true; CUSTOM_FLAG_USED=true
             autocor_file_coulomb="$2"
             autocor_file_lj="$3"
             shift 3
             ;;
             
        -diff)
             DO_DIFF=true; CUSTOM_FLAG_USED=true
             diff_file="$2"
             shift 2  # Desloca 2 (1 da flag + 1 argumento)
             ;;
             
        -conv_pbsa)
             DO_CONV_PBSA=true
             CUSTOM_FLAG_USED=true
             conv_pbsa_file="$2"
             shift 2
             ;;
             
        -extract_qm)
             # Verifica se há argumentos suficientes (3 argumentos obrigatórios)
             if [[ -z "$2" ]] || [[ -z "$3" ]] || [[ -z "$4" ]]; then
                 echo "Error: -extract_qm requires 3 arguments."
                 echo "Usage: gmx_ISA -extract_qm <Resname> <Cutoff> <Stride>"
                 exit 1
             fi
             DO_EXTRACT_QM=true
             CUSTOM_FLAG_USED=true
             qm_resname="$2"
             qm_cutoff="$3"
             qm_stride="$4"
             shift 4   # Desloca 4 posições (1 da flag + 3 argumentos)
             ;;
             
         -xtb_run)
             DO_XTB_RUN=true
             CUSTOM_FLAG_USED=true
             
             # Verifica se o próximo argumento é a flag obrigatória
             if [[ "$2" == "--ligand_charge" ]]; then
                 # Verifica se existe um valor após a flag
                 if [[ -z "$3" ]]; then
                     echo "Error: Missing value for --ligand_charge."
                     exit 1
                 fi
                 xtb_charge="$3"
                 shift 3  # Desloca: -xtb_run, --ligand_charge, valor
             else
                 echo "Error: Usage incorrect. Use: gmx_ISA -xtb_run --ligand_charge <integer>"
                 exit 1
             fi
             ;;

        -fel3d)
        # --- VERIFICAÇÃO DE SEGURANÇA ---
        # Verifica se algum dos 4 argumentos obrigatórios está vazio
        if [[ -z "$2" ]] || [[ -z "$3" ]] || [[ -z "$4" ]] || [[ -z "$5" ]]; then
            echo "--------------------------------------------------------"
            echo "ERROR: Missed arguments for -fel3d!"
            echo "       You need to set 4 values in the exact order"
            echo ""
            echo "       Correct usage: -fel3d <PC_file> <temperarture> <bins> <sigma_smooth>"
            echo "       Example:       -fel3d gibbs.xvg 300 50 10"
            echo "--------------------------------------------------------"
            exit 1  # Para o script aqui para evitar o travamento
        fi
        # --------------------------------
             DO_FEL3D=true; CUSTOM_FLAG_USED=true
             fel3d_file="$2"
             fel3d_temp="$3"
             fel3d_bins="$4"
             fel3d_sigma="$5"
             shift 5   # Desloca 5 posições (1 da flag + 4 argumentos)
             ;;

        # IGNORAR
        -h|-solo) shift ;; 
        *) echo "Warning: Unknown flag $1"; shift ;;
    esac
done

# ==============================================================================
# --- TRAVA DE SEGURANÇA: EXCLUSÃO MÚTUA DE ROTINAS PYTHON ---
# ==============================================================================
# Conta quantas flags de análise externa (Python) foram ativadas
py_analysis_count=0
if [ "$DO_FEL3D" = true ]; then ((py_analysis_count++)); fi
if [ "$DO_INT" = true ]; then ((py_analysis_count++)); fi
if [ "$DO_REG" = true ]; then ((py_analysis_count++)); fi
if [ "$DO_ISA" = true ]; then ((py_analysis_count++)); fi
if [ "$DO_AUTOCOR" = true ]; then ((py_analysis_count++)); fi
if [ "$DO_DIFF" = true ]; then ((py_analysis_count++)); fi
if [ "$DO_CONV_PBSA" = true ]; then ((py_analysis_count++)); fi
if [ "$DO_EXTRACT_QM" = true ]; then ((py_analysis_count++)); fi
if [ "$DO_XTB_RUN" = true ]; then ((py_analysis_count++)); fi

# Se houver mais de uma, aborta a execução de forma limpa
if [ $py_analysis_count -gt 1 ]; then
    echo ""
    echo "================================================================"
    echo " CRITICAL ERROR: Multiple external analyses detected."
    echo "================================================================"
    echo " To ensure data integrity and prevent memory/file conflicts,"
    echo " gmx_ISA can only run ONE Python-based routine at a time."
    echo ""
    echo " You selected $py_analysis_count flags simultaneously."
    echo " Please run them as separate commands."
    echo "================================================================"
    exit 1
fi

# ==============================================================================
# 6. VALIDAÇÃO FINAL DOS ARQUIVOS
# ==============================================================================

if [[ -z "$tpr" ]]; then tpr=$(find . -maxdepth 1 -type f -name "*.tpr" | head -n 1); fi
if [[ -z "$xtc" ]]; then xtc=$(find . -maxdepth 1 -type f -name "*.xtc" | head -n 1); fi
if [[ -z "$ndx" ]]; then ndx=$(find . -maxdepth 1 -type f -name "*.ndx" | head -n 1); fi
if [[ -z "$edr" ]]; then edr=$(find . -maxdepth 1 -type f -name "*.edr" | head -n 1); fi

if [ "$solo_mode" = false ]; then
    if [[ ! -f "$tpr" ]]; then echo "Error: *.tpr file not found ($tpr). Use -s [file] or check variables.conf"; exit 1; fi
    if [[ ! -f "$xtc" ]]; then echo "Error: *.xtc file not found ($xtc). Use -f [file] or check variables.conf"; exit 1; fi
    if [[ ! -f "$ndx" ]]; then echo "Error: *.ndx file not found ($ndx). Use -n [file] or check variables.conf"; exit 1; fi
    
    if [[ "$CUSTOM_FLAG_USED" = false || "$DO_ETOT" = true || "$DO_ECOUL" = true || "$DO_ELJ" = true ]]; then
        if [[ ! -f "$edr" ]]; then echo "Error: *.edr file not found ($edr). Use -en [file] or check variables.conf"; exit 1; fi
    fi
    
    if [[ -z "$Protein" || -z "$Ligand" || -z "$System" || -z "$Backbone" ]]; then
       echo "Error: Index Group variables (Protein, Ligand, etc) are missing. Check 'variables.conf'."
       exit 1
    fi
fi

# ==============================================================================
# 7. EXECUÇÃO DAS ANÁLISES
# ==============================================================================

if [[ ! -d "gmx_ISA-ANALYSIS" ]]; then mkdir gmx_ISA-ANALYSIS; fi

if [ "$CUSTOM_FLAG_USED" = false ]; then
    echo "No custom analysis flags detected. Queueing FULL default analysis..."
    DO_CENTER=true
    DO_RMS_LIG=true; DO_RMS_LIG2=true; DO_RMS_PROT=true
    DO_RMSF_PROT=true; DO_RMSF_LIG=true
    DO_HBOND=true
    DO_ETOT=true; DO_ECOUL=true; DO_ELJ=true
fi

# --- BLOCO DE EXECUÇÃO ---

################################################################################
# START OF QM EXECUTIONS
################################################################################

if [ "$DO_EXTRACT_QM" = true ]; then
    SCRIPT_QM="$PYTHON_DIR/extract_qm_cli.py"

    # 1. Verificações básicas
    if [ ! -f "$SCRIPT_QM" ]; then
        echo "Error: Internal python script missing at $SCRIPT_QM"
        exit 1
    fi
    
    # Validação de variáveis obrigatórias do GROMACS
    if [[ -z "$tpr" ]]; then tpr=$(find . -maxdepth 1 -type f -name "*.tpr" | head -n 1); fi
    if [[ -z "$xtc" ]]; then xtc=$(find . -maxdepth 1 -type f -name "*.xtc" | head -n 1); fi
    
    if [[ ! -f "$tpr" ]] || [[ ! -f "$xtc" ]]; then
        echo "Error: TPR or XTC files not found needed for QM extraction."
        exit 1
    fi

    echo ""
    echo "=========================================================="
    echo "          STARTING QM EXTRACTION & CAPPING"
    echo "=========================================================="
    
    # 2. Gerar center.xtc (Requisito 3)
    # Usa a variável $System definida no variables.conf ou input
    echo "-> Generating centered trajectory (center.xtc)..."
    
    # Verifica se $System está definido, senão tenta adivinhar ou falha
    if [[ -z "$System" ]]; then
        echo "Warning: Variable 'System' not defined. Using default group 0 for centering."
        System="0"
    fi

    # Executa o trjconv. Não usamos progress_bar para manter o fluxo visível se der erro.
    { echo "$System"; echo "$System"; } | gmx trjconv -s "$tpr" -f "$xtc" -n "$ndx" -o center.xtc -center -pbc mol > /dev/null 2>&1
    
    if [[ ! -f "center.xtc" ]]; then
        echo "❌ Error: Failed to generate center.xtc. Check your index file and system group."
        exit 1
    fi
    echo "✅ center.xtc generated successfully."
    echo ""

    # 3. Executar o Script Python (Requisito 1 e 2)
    # Executa DIRETAMENTE (sem progress_bar_real_time) para ver o output
    # Argumentos esperados pelo python: tpr, xtc, lig_resname, cutoff, stride
    
    python3 "$SCRIPT_QM" "$tpr" "center.xtc" "$qm_resname" "$qm_cutoff" "$qm_stride"
    
    # Código de retorno do python
    RET_VAL=$?
    
    if [ $RET_VAL -ne 0 ]; then
        echo ""
        echo "❌ Error during Python execution. Aborting."
        exit 1
    fi

    # 4. Organização de Arquivos (Requisito 4)
    echo ""
    echo "-> Organizing output files..."
    
    DIR_QM="QM_analysis"
    if [ ! -d "$DIR_QM" ]; then mkdir "$DIR_QM"; fi
    
    # Move a pasta gerada pelo Python (QM_FRAMES_CAPPED) para dentro de QM_analysis
    if [ -d "QM_FRAMES_CAPPED" ]; then
        mv "QM_FRAMES_CAPPED" "$DIR_QM/"
    fi
    
    # Move o center.xtc para lá também
    mv center.xtc "$DIR_QM/"
    
    echo "✅ All files moved to ./$DIR_QM"
    echo "=========================================================="
    echo "Done."
    
    # 5. Encerramento Exclusivo (Requisito 1)
    exit 0
fi

if [ "$DO_XTB_RUN" = true ]; then
    SCRIPT_XTB="$PYTHON_DIR/xtb_run.py"

    # 1. Verificações de Segurança
    if [ ! -f "$SCRIPT_XTB" ]; then
        echo "Error: Internal python script missing at $SCRIPT_XTB"
        exit 1
    fi

    # Verifica se a pasta QM_analysis existe (requisito lógico)
    if [ ! -d "QM_analysis" ]; then
        echo "Error: Directory 'QM_analysis' not found."
        echo "       Please run 'gmx_ISA -extract_qm ...' first."
        exit 1
    fi
    
    # Identifica o arquivo .edr
    if [[ -z "$edr" ]]; then edr=$(find . -maxdepth 1 -type f -name "*.edr" | head -n 1); fi
    if [[ ! -f "$edr" ]]; then
        echo "Error: Energy file (.edr) not found."
        exit 1
    fi
    
    # Carrega variáveis do arquivo SE elas estiverem vazias na memória
    if [[ -z "$CoulombSR" || -z "$LJSR" ]]; then
        if [[ -f "variables.conf" ]]; then source variables.conf; fi
    fi
    
    # Verifica se as variáveis foram carregadas
    if [[ -z "$CoulombSR" || -z "$LJSR" ]]; then
         echo "Error: CoulombSR or LJSR variables not defined in variables.conf"
         exit 1
    fi

    echo ""
    echo "=========================================================="
    echo "            STARTING XTB CALCULATION WRAPPER"
    echo "=========================================================="

    # 2. Gerar coul_lj_sr.xvg (Com sanitização temporária)
    # CORREÇÃO: O nome do arquivo agora é coul_lj_sr.xvg (com 'l') para bater com o Python
    echo "-> Extracting MM energies (Coulomb/LJ) from $edr..."
    
    clean_coul=$(echo "$CoulombSR" | sed 's/[: ]0$//')
    clean_lj=$(echo "$LJSR" | sed 's/[: ]0$//')
    
    # Output corrigido para coul_lj_sr.xvg
    printf "$clean_coul\n$clean_lj\n0\n" | gmx energy -f "$edr" -o coul_lj_sr.xvg > /dev/null 2>&1
    
    if [[ ! -f "coul_lj_sr.xvg" ]]; then
        echo "❌ Error: Failed to generate coul_lj_sr.xvg."
        echo "   Check if '$clean_coul' and '$clean_lj' are correct terms in your .edr file."
        exit 1
    fi
    echo "✅ coul_lj_sr.xvg generated successfully."

    # 3. Organização e Execução
    # Mantemos o 'mv' aqui. É ESSENCIAL mover antes, pois o script roda dentro da pasta.
    echo "-> Moving files to QM_analysis..."
    mv coul_lj_sr.xvg QM_analysis/
    
    # Entra na pasta para rodar o script localmente
    cd QM_analysis || exit 1
    
    echo "-> Executing Python script (xtb_run.py)..."
    echo "   Ligand Charge: $xtb_charge"
    echo "   -------------------------------------------------------"
    
    # Executa o script Python
    python3 "$SCRIPT_XTB" --ligand_charge "$xtb_charge" --base_dir "QM_FRAMES_CAPPED"
    
    RET_VAL=$?
    
    # Retorna ao diretório original
    cd ..
    
    if [ $RET_VAL -ne 0 ]; then
        echo ""
        echo "❌ Error during Python execution."
        exit 1
    fi

    echo ""
    echo "=========================================================="
    echo "✅ xTB Pipeline Finished."
    echo "   Check results in ./QM_analysis"
    echo "=========================================================="
    
    # 5. Encerramento Exclusivo
    exit 0
fi

################################################################################
# END OF QM EXECUTIONS
################################################################################

if [ "$DO_GYR" = true ]; then
    echo "Executing Radius of Gyration analysis..."
    progress_bar_real_time "echo \"$Backbone\" | gmx gyrate -s \"$tpr\" -f \"$xtc\" -n \"$ndx\" -o gyrate.xvg"
fi

if [ "$DO_SASA" = true ]; then
    echo "Executing SASA analysis..."
    progress_bar_real_time "echo \"$Backbone\" | gmx sasa -f \"$xtc\" -s \"$tpr\" -n \"$ndx\" -o sasa.xvg -tu ns"
fi

if [ "$DO_CENTER" = true ]; then
    echo "Executing trajectory centering..."
    progress_bar_real_time "{ echo \"$System\"; echo \"$System\"; } | gmx trjconv -s \"$tpr\" -f \"$xtc\" -n \"$ndx\" -o center.xtc -center -pbc mol"
fi

if [ "$DO_RMS_LIG" = true ]; then
    echo "Executing RMSD calculations for the ligand..."
    progress_bar_real_time "{ echo \"$Ligand\"; echo \"$Ligand\"; } | gmx rms -s \"$tpr\" -f \"$xtc\" -n \"$ndx\" -o LIG-LIG_rmsd.xvg -tu ns"
fi

if [ "$DO_RMS_LIG2" = true ]; then
    echo "Executing RMSD calculations for the ligand (no H)..."
    progress_bar_real_time "{ echo \"$Ligand2\"; echo \"$Ligand2\"; } | gmx rms -s \"$tpr\" -f \"$xtc\" -n \"$ndx\" -o LIG-LIG-2_rmsd.xvg -tu ns"
fi

if [ "$DO_RMS_PROT" = true ]; then
    echo "Executing RMSD calculations for the protein..."
    progress_bar_real_time "{ echo \"$Backbone\"; echo \"$Backbone\"; } | gmx rms -s \"$tpr\" -f \"$xtc\" -n \"$ndx\" -o PROT-PROT_rmsd.xvg -tu ns"
fi

if [ "$DO_RMSF_PROT" = true ]; then
    echo "Calculating protein RMSF..."
    progress_bar_real_time "echo \"$Protein\" | gmx rmsf -f \"$xtc\" -s \"$tpr\" -n \"$ndx\" -o rmsf_PROT.xvg -res"
fi

if [ "$DO_RMSF_LIG" = true ]; then
    echo "Calculating ligand RMSF..."
    progress_bar_real_time "echo \"$Ligand\" | gmx rmsf -f \"$xtc\" -s \"$tpr\" -n \"$ndx\" -o rmsf_LIG.xvg"
fi

if [ "$DO_HBOND" = true ]; then
    echo "Calculating Hydrogen Bonds..."
    target_xtc="$xtc"
    if [[ -f "center.xtc" ]]; then
         target_xtc="center.xtc"
    else
         echo "   -> Attempting to generate temporary center.xtc..."
         { echo "$System"; echo "$System"; } | gmx trjconv -s "$tpr" -f "$xtc" -n "$ndx" -o center.xtc -center -pbc mol >> gmx_ISA_debug.log 2>&1
         if [[ -f "center.xtc" ]]; then
             target_xtc="center.xtc"
         else
             echo "   -> WARNING: Could not generate center.xtc (Check gmx_ISA_debug.log)."
             echo "   -> FALLBACK: Running HBond analysis on original trajectory ($xtc)."
             target_xtc="$xtc"
         fi
    fi
    progress_bar_real_time "{ echo \"$Protein\"; echo \"$Ligand\"; } | gmx hbond -n \"$ndx\" -s \"$tpr\" -f \"$target_xtc\" -num numLigH.xvg -tu ns"
fi

if [ "$DO_RDF" = true ]; then
    echo "Calculating Radial Distribution Function (Ligand - Water)..."
    target_xtc="$xtc"
    if [[ -f "center.xtc" ]]; then
         target_xtc="center.xtc"
    else
         echo "   -> Attempting to generate temporary center.xtc..."
         { echo "$System"; echo "$System"; } | gmx trjconv -s "$tpr" -f "$xtc" -n "$ndx" -o center.xtc -center -pbc mol >> gmx_ISA_debug.log 2>&1
         if [[ -f "center.xtc" ]]; then
             target_xtc="center.xtc"
         else
             echo "   -> WARNING: Could not generate center.xtc (Check gmx_ISA_debug.log)."
             echo "   -> FALLBACK: Running RDF analysis on original trajectory ($xtc)."
             target_xtc="$xtc"
         fi
    fi
    echo "Executing RDF analysis..."
    progress_bar_real_time "gmx rdf -f \"$target_xtc\" -s \"$tpr\" -n \"$ndx\" -ref \"$Ligand\" -sel \"name OW\" -o rdf_ligand_water.xvg"
fi

if [ "$DO_ETOT" = true ]; then
    echo "Calculating Total Energy..."
    progress_bar_real_time "echo \"$TotalE\" | gmx energy -f \"$edr\" -o total_energy.xvg"
fi

if [ "$DO_ECOUL" = true ]; then
    echo "Calculating Coulomb-SR Energy..."
    progress_bar_real_time "echo \"$CoulombSR\" | gmx energy -f \"$edr\" -o coulomb_SR.xvg"
fi

if [ "$DO_ELJ" = true ]; then
    echo "Calculating LJ-SR Energy..."
    progress_bar_real_time "echo \"$LJSR\" | gmx energy -f \"$edr\" -o LJ_SR.xvg"
fi

if [ "$DO_INT" = true ]; then
      # Define o caminho do script Python interno
      SCRIPT_INT="$PYTHON_DIR/int.py"
      
      # Verifica se o usuário passou os argumentos corretamente
      if [ -z "$int_file_coulomb" ] || [ -z "$int_file_lj" ]; then
          echo "Error: -int requires two .xvg files as arguments."
          echo "Usage: gmx_ISA -int <coulomb.xvg> <lj.xvg>"
      
      # Verifica se os arquivos que o usuário indicou existem mesmo
      elif [ ! -f "$int_file_coulomb" ]; then
          echo "Error: File '$int_file_coulomb' not found."
      elif [ ! -f "$int_file_lj" ]; then
          echo "Error: File '$int_file_lj' not found."
      
      # Verifica se o script Python interno está no lugar certo
      elif [ ! -f "$SCRIPT_INT" ]; then
          echo "Error: Internal python script missing at $SCRIPT_INT"
      
      else
          echo "Calculating Interaction Statistics via Python..."
          
          # Define o nome do arquivo de log
          LOG_PY="interaction_python.log"
          
          # Chama o Python passando os arquivos escolhidos pelo usuário
          progress_bar_real_time "python3 \"$SCRIPT_INT\" \"$int_file_coulomb\" \"$int_file_lj\" > \"$LOG_PY\""
          
          # Exibe o resultado na tela (lendo o arquivo que o Python gerou)
          if [[ -f "interaction_energy_statistics.dat" ]]; then
              cat "interaction_energy_statistics.dat"
          else
              echo "Warning: Output file not generated. Check input files format."
          fi
      fi
fi

if [ "$DO_FEL" = true ]; then
    if [[ -z "$fel_sys" || -z "$fel_b" || -z "$fel_e" ]]; then
       echo "Error: FEL requires -sys, -b, and -e."
    else
        if [[ "$fel_sys" == "protein" ]]; then G="$Protein"; P="prot"; else G="$Ligand"; P="lig"; fi
        echo "Executing FEL for $fel_sys..."
        progress_bar_real_time "{ echo \"$G\"; echo \"$G\"; } | gmx covar -f \"$xtc\" -s \"$tpr\" -n \"$ndx\" -o ${P}_eigenval.xvg -v ${P}_eigenvec.trr -b $fel_b -e $fel_e -tu ns"
        progress_bar_real_time "{ echo \"$G\"; echo \"$G\"; } | gmx anaeig -v ${P}_eigenvec.trr -f \"$xtc\" -eig ${P}_eigenval.xvg -s \"$tpr\" -first 1 -last 2 -2d ${P}_pca.xvg -n \"$ndx\""
        gmx sham -f ${P}_pca.xvg -ls ${P}_fel.xpm -notime >> gmx_ISA_debug.log 2>&1
        gmx xpm2ps -f ${P}_fel.xpm -o ${P}_fel.eps -rainbow red >> gmx_ISA_debug.log 2>&1
    fi
fi

if [ "$DO_FEL3D" = true ]; then
    SCRIPT_FEL3D="$PYTHON_DIR/fel3d.py"

    # 1. Verificações de Segurança
    if [ -z "$fel3d_file" ] || [ -z "$fel3d_temp" ] || [ -z "$fel3d_bins" ] || [ -z "$fel3d_sigma" ]; then
        echo "Error: -fel3d requires 4 arguments."
        echo "Usage: gmx_ISA -fel3d <pc1_pc2.xvg> <Temp_K> <bins> <sigma>"
    elif [ ! -f "$fel3d_file" ]; then
        echo "Error: Input file '$fel3d_file' not found."
    elif [ ! -f "$SCRIPT_FEL3D" ]; then
        echo "Error: Internal python script missing at $SCRIPT_FEL3D"
    else
        # 2. Execução Verbosa e Interativa
        echo ""
        echo "=========================================================="
        echo "       STARTING INTERACTIVE 3D FEL ANALYSIS"
        echo "=========================================================="
        echo " -> A plotting window will open shortly."
        echo " -> You can rotate, zoom and inspect the 3D surface."
        echo " -> IMPORTANT: CLOSE THE PLOT WINDOW TO FINISH THE SCRIPT."
        echo "=========================================================="
        echo ""
        
        # Executa o Python diretamente no terminal (Foreground)
        python3 "$SCRIPT_FEL3D" "$fel3d_file" "$fel3d_temp" "$fel3d_bins" "$fel3d_sigma"
        
        echo ""
        echo "Analysis window closed. Resuming script..."
    fi
fi

if [ "$DO_REG" = true ]; then
      SCRIPT_REG="$PYTHON_DIR/reg.py"
      
      # 1. Verificações de segurança
      if [ -z "$reg_file_coulomb" ] || [ -z "$reg_file_lj" ]; then
          echo "Error: -reg requires two .xvg files."
          echo "Usage: gmx_ISA -reg <coulomb.xvg> <lj.xvg>"
      elif [ ! -f "$reg_file_coulomb" ]; then
          echo "Error: File '$reg_file_coulomb' not found."
      elif [ ! -f "$reg_file_lj" ]; then
          echo "Error: File '$reg_file_lj' not found."
      elif [ ! -f "$SCRIPT_REG" ]; then
          echo "Error: Internal python script missing at $SCRIPT_REG"
      else
          echo "Calculating Linear Regression (Coulomb vs LJ)..."
          
          LOG_REG="reg_python.log"
          
          # 2. Execução com barra de progresso e log
          progress_bar_real_time "python3 \"$SCRIPT_REG\" \"$reg_file_coulomb\" \"$reg_file_lj\" > \"$LOG_REG\""
          
          # 3. Mostra o resultado do log na tela
          if [[ -f "$LOG_REG" ]]; then
              cat "$LOG_REG"
          fi
      fi
fi

if [ "$DO_ISA" = true ]; then
      SCRIPT_ISA="$PYTHON_DIR/isa.py"
      
      # 1. Verificações de segurança
      if [ -z "$isa_file_coulomb" ] || [ -z "$isa_file_lj" ]; then
          echo "Error: -isa requires two .xvg files."
          echo "Usage: gmx_ISA -isa <coulomb.xvg> <lj.xvg>"
      elif [ ! -f "$isa_file_coulomb" ]; then
          echo "Error: File '$isa_file_coulomb' not found."
      elif [ ! -f "$isa_file_lj" ]; then
          echo "Error: File '$isa_file_lj' not found."
      elif [ ! -f "$SCRIPT_ISA" ]; then
          echo "Error: Internal python script missing at $SCRIPT_ISA"
      else
          echo "Calculating Interaction Stability Analysis (ISA)..."
          
          LOG_ISA="isa_python.log"
          OUTPUT_DAT="ISA_results.dat"
          
          # 2. Execução com barra de progresso (Log técnico vai para isa_python.log)
          progress_bar_real_time "python3 \"$SCRIPT_ISA\" \"$isa_file_coulomb\" \"$isa_file_lj\" > \"$LOG_ISA\""
          
          # 3. Exibe o RESULTADO final na tela (o arquivo .dat gerado pelo python)
          if [[ -f "$OUTPUT_DAT" ]]; then
              echo "---------------------------------------------------"
              cat "$OUTPUT_DAT"
              echo "---------------------------------------------------"
          else
              echo "Warning: Output file '$OUTPUT_DAT' not generated."
              # Se falhou, mostra o log de erro
              if [[ -f "$LOG_ISA" ]]; then cat "$LOG_ISA"; fi
          fi
      fi
fi

if [ "$DO_AUTOCOR" = true ]; then
    SCRIPT_AUTOCOR="$PYTHON_DIR/autocor.py"

    # 1. Verificações
    if [ -z "$autocor_file_coulomb" ] || [ -z "$autocor_file_lj" ]; then
        echo "Error: -autocor requires two .xvg files."
        echo "Usage: gmx_ISA -autocor <coulomb.xvg> <lj.xvg>"
    elif [ ! -f "$autocor_file_coulomb" ]; then
        echo "Error: File '$autocor_file_coulomb' not found."
    elif [ ! -f "$autocor_file_lj" ]; then
        echo "Error: File '$autocor_file_lj' not found."
    elif [ ! -f "$SCRIPT_AUTOCOR" ]; then
        echo "Error: Internal python script missing at $SCRIPT_AUTOCOR"
    else
        echo "Calculating Interaction Energy Autocorrelation..."
        
        LOG_AUTOCOR="autocor_python.log"
        OUTPUT_DAT="interaction_autocorrelation_results.dat"
        
        # 2. Execução com barra de progresso
        progress_bar_real_time "python3 \"$SCRIPT_AUTOCOR\" \"$autocor_file_coulomb\" \"$autocor_file_lj\" > \"$LOG_AUTOCOR\""
        
        # 3. Exibe o resultado principal na tela (Tempo de Correlação)
        if [[ -f "$OUTPUT_DAT" ]]; then
            echo "---------------------------------------------------"
            # Mostra apenas as linhas essenciais do resultado para não poluir
            grep -A 1 "Correlation time (tau_c)" "$OUTPUT_DAT"
            echo "---------------------------------------------------"
        else
            echo "Warning: Output file '$OUTPUT_DAT' not generated."
            if [[ -f "$LOG_AUTOCOR" ]]; then cat "$LOG_AUTOCOR"; fi
        fi
    fi
fi

if [ "$DO_DIFF" = true ]; then
    SCRIPT_DIFF="$PYTHON_DIR/diff.py"

    # 1. Verificações de Segurança
    if [ -z "$diff_file" ]; then
        echo "Error: -diff requires an MSD .xvg file."
        echo "Usage: gmx_ISA -diff <msd.xvg>"
    elif [ ! -f "$diff_file" ]; then
        echo "Error: File '$diff_file' not found."
    elif [ ! -f "$SCRIPT_DIFF" ]; then
        echo "Error: Internal python script missing at $SCRIPT_DIFF"
    else
        echo "Calculating Diffusion Coefficient from MSD..."
        
        LOG_DIFF="diff_python.log"
        
        # Descobre o nome base do arquivo para saber qual .dat o python vai gerar
        # Ex: se entrada é "msd_lig.xvg", base é "msd_lig"
        base_name=$(basename "$diff_file" .xvg)
        OUTPUT_DAT="${base_name}_diffusion_results.dat"
        
        # 2. Execução com barra de progresso
        progress_bar_real_time "python3 \"$SCRIPT_DIFF\" \"$diff_file\" > \"$LOG_DIFF\""
        
        # 3. Exibe o resultado na tela
        if [[ -f "$OUTPUT_DAT" ]]; then
            echo "---------------------------------------------------"
            cat "$OUTPUT_DAT"
            echo "---------------------------------------------------"
        else
            echo "Warning: Output file '$OUTPUT_DAT' not generated."
            # Se falhou, mostra o log de erro
            if [[ -f "$LOG_DIFF" ]]; then cat "$LOG_DIFF"; fi
        fi
    fi
fi

if [ "$DO_CONV_PBSA" = true ]; then
    SCRIPT_CONV="$PYTHON_DIR/conv_pbsa.py"

    # 1. Verificações de Segurança
    if [ -z "$conv_pbsa_file" ]; then
        echo "Error: -conv_pbsa requires a CSV file."
        echo "Usage: gmx_ISA -conv_pbsa <gmx_mmpbsa_results.csv>"
    elif [ ! -f "$conv_pbsa_file" ]; then
        echo "Error: File '$conv_pbsa_file' not found."
    elif [ ! -f "$SCRIPT_CONV" ]; then
        echo "Error: Internal python script missing at $SCRIPT_CONV"
    else
        echo "Calculating MM/PBSA Convergence Analysis..."
        
        LOG_CONV="conv_pbsa_python.log"
        STATS_FILE="convergence_stats.csv"
        
        # 2. Execução com barra de progresso
        progress_bar_real_time "python3 \"$SCRIPT_CONV\" \"$conv_pbsa_file\" > \"$LOG_CONV\""
        
        # 3. Exibe o resultado na tela (se houve convergência)
        if [[ -f "$STATS_FILE" ]]; then
            echo "---------------------------------------------------"
            echo "Convergence Statistics:"
            cat "$STATS_FILE"
            echo "---------------------------------------------------"
        else
            # Se não gerou stats, pode não ter convergido ou deu erro
            if [[ -f "$LOG_CONV" ]]; then 
                # Mostra o log caso tenha erros ou aviso de não convergência
                cat "$LOG_CONV" 
            fi
        fi
    fi
fi

# ==============================================================================
# 8. FINALIZAÇÃO E MOVIMENTAÇÃO DE ARQUIVOS
# ==============================================================================

echo ""
echo "All calculations finished. Moving files to 'gmx_ISA-ANALYSIS'..."

mv *.xvg gmx_ISA-ANALYSIS/ 2>/dev/null
mv center.xtc gmx_ISA-ANALYSIS/ 2>/dev/null
mv interaction.dat gmx_ISA-ANALYSIS/ 2>/dev/null
mv *.trr *.xpm *.eps gmx_ISA-ANALYSIS/ 2>/dev/null

mv interaction_energy_statistics.dat gmx_ISA-ANALYSIS/ 2>/dev/null
mv interaction.dat gmx_ISA-ANALYSIS/ 2>/dev/null
mv interaction_python.log gmx_ISA-ANALYSIS/ 2>/dev/null
mv FEL_*.png gmx_ISA-ANALYSIS/ 2>/dev/null
mv FEL_*.csv gmx_ISA-ANALYSIS/ 2>/dev/null

mv interaction_energy_analysis.dat gmx_ISA-ANALYSIS/ 2>/dev/null
mv interaction_energy_coulomb_vs_lj.png gmx_ISA-ANALYSIS/ 2>/dev/null
mv reg_python.log gmx_ISA-ANALYSIS/ 2>/dev/null

mv ISA_results.dat gmx_ISA-ANALYSIS/ 2>/dev/null
mv isa_python.log gmx_ISA-ANALYSIS/ 2>/dev/null

mv interaction_energy.png gmx_ISA-ANALYSIS/ 2>/dev/null
mv interaction_energy_autocorrelation.png gmx_ISA-ANALYSIS/ 2>/dev/null
mv interaction_energy.csv gmx_ISA-ANALYSIS/ 2>/dev/null
mv interaction_energy_autocorrelation.csv gmx_ISA-ANALYSIS/ 2>/dev/null
mv interaction_autocorrelation_results.dat gmx_ISA-ANALYSIS/ 2>/dev/null
mv autocor_python.log gmx_ISA-ANALYSIS/ 2>/dev/null

mv *_diffusion_results.dat gmx_ISA-ANALYSIS/ 2>/dev/null
mv *_best_linear_region.csv gmx_ISA-ANALYSIS/ 2>/dev/null
mv *_msd_*.png gmx_ISA-ANALYSIS/ 2>/dev/null
mv diff_python.log gmx_ISA-ANALYSIS/ 2>/dev/null

mv cumulative_average.csv gmx_ISA-ANALYSIS/ 2>/dev/null
mv convergence_stats.csv gmx_ISA-ANALYSIS/ 2>/dev/null
mv plot_cumulative_avg.png gmx_ISA-ANALYSIS/ 2>/dev/null
mv plot_convergence_check.png gmx_ISA-ANALYSIS/ 2>/dev/null
mv conv_pbsa_python.log gmx_ISA-ANALYSIS/ 2>/dev/null

if [[ -f "gmx_ISA_debug.log" ]]; then
    mv gmx_ISA_debug.log gmx_ISA-ANALYSIS/
fi

echo "Done! Check 'gmx_ISA-ANALYSIS' folder."